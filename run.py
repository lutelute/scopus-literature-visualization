#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
run.py - Scopusæ–‡çŒ®å¯è¦–åŒ–ã‚·ã‚¹ãƒ†ãƒ  ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ï¼š
1. ä¾å­˜é–¢ä¿‚ã®è‡ªå‹•ãƒã‚§ãƒƒã‚¯ãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
2. ç’°å¢ƒã®è‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
3. ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èµ·å‹•
ã‚’è¡Œã„ã¾ã™ã€‚
"""

import os
import sys
import subprocess
import importlib.util

def ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯ãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«():
    """å¿…é ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ç¢ºèªã¨è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"""
    å¿…é ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ = [
        'pandas',
        'requests', 
        'requests_cache',
        'tqdm'
    ]
    
    print("[INFO] ä¾å­˜é–¢ä¿‚ã‚’ãƒã‚§ãƒƒã‚¯ä¸­...")
    æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« = []
    
    for ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å in å¿…é ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸:
        spec = importlib.util.find_spec(ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å)
        if spec is None:
            æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«.append(ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å)
            print(f"  [NG] {ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å} - æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«")
        else:
            print(f"  [OK] {ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å} - ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿")
    
    if æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«:
        print(f"\n[WARN]  {len(æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«)}å€‹ã®å¿…é ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒä¸è¶³ã—ã¦ã„ã¾ã™")
        print(f"[PKG] è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’å®Ÿè¡Œã—ã¾ã™...")
        
        try:
            subprocess.check_call([
                sys.executable, '-m', 'pip', 'install'
            ] + æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«)
            print(f"[OK] ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†: {', '.join(æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«)}")
            return True
        except subprocess.CalledProcessError as e:
            print(f"[NG] è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¤±æ•—: {e}")
            print(f"\n[HINT] æ‰‹å‹•ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„:")
            print(f"pip install {' '.join(æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«)}")
            return False
    else:
        print(f"[OK] å¿…é ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯å…¨ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã§ã™")
        return True

def ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒã‚§ãƒƒã‚¯():
    """ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ç¢ºèª"""
    ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ = ['aiohttp', 'nltk']
    æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« = []
    
    print(f"\n[INFO] ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ãƒã‚§ãƒƒã‚¯ä¸­...")
    for ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å in ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸:
        spec = importlib.util.find_spec(ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å)
        if spec is None:
            æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«.append(ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å)
            print(f"  [WARN]  {ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å} - æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆæ¨™æº–ç‰ˆã§å‹•ä½œï¼‰")
        else:
            print(f"  [OK] {ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å} - ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ï¼ˆé«˜é€ŸåŒ–æ©Ÿèƒ½åˆ©ç”¨å¯èƒ½ï¼‰")
    
    if æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«:
        print(f"\n[HINT] é«˜é€ŸåŒ–ã®ãŸã‚ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™:")
        print(f"pip install {' '.join(æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«)}")
        print(f"\nğŸ“ æ©Ÿèƒ½å·®:")
        if 'aiohttp' in æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«:
            print(f"  - aiohttp: DOIè§£æ±ºãŒ8å€é«˜é€ŸåŒ–ï¼ˆä¸¦åˆ—å‡¦ç†ï¼‰")
        if 'nltk' in æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«:
            print(f"  - nltk: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ†æãŒé«˜ç²¾åº¦åŒ–ï¼ˆå“è©è§£æï¼‰")

def ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—():
    """å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ"""
    å¿…è¦ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª = ['JSON_folder', 'md_folder', 'PDF']
    
    print(f"\n[DIR] å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­...")
    for ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª in å¿…è¦ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª:
        if not os.path.exists(ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª):
            os.makedirs(ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª)
            print(f"  [DIR] {ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª}/ ã‚’ä½œæˆ")
        else:
            print(f"  [OK] {ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª}/ æ—¢å­˜")

def CSVãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª():
    """å…¥åŠ›CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª"""
    print(f"\n[FILE] å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ä¸­...")
    
    # è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆä½œæ¥­ãƒ•ã‚©ãƒ«ãƒ€ï¼‰ã§CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
    è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª = os.path.dirname(os.getcwd())
    csv_files = [f for f in os.listdir(è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª) 
                 if f.endswith('.csv') and f != 'scopus_combined.csv']
    
    if csv_files:
        print(f"  [OK] {len(csv_files)}ä»¶ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç™ºè¦‹:")
        for csv_file in csv_files[:3]:
            print(f"    - {csv_file}")
        if len(csv_files) > 3:
            print(f"    - ... ä»–{len(csv_files)-3}ä»¶")
        return True
    else:
        print(f"  [WARN]  CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        print(f"  ğŸ“ ä½¿ç”¨æ–¹æ³•:")
        print(f"    1. ä½œæ¥­ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ")
        print(f"    2. Scopus CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®")
        print(f"    3. ãƒ„ãƒ¼ãƒ«ã‚’ã‚¯ãƒ­ãƒ¼ãƒ³")
        print(f"    4. python3 run.py ã‚’å®Ÿè¡Œ")
        return False

def ä»®æƒ³ç’°å¢ƒãƒã‚§ãƒƒã‚¯():
    """ä»®æƒ³ç’°å¢ƒã®ç¢ºèªã¨æ¡ˆå†…"""
    venv_path = '.venv'
    
    if os.path.exists(venv_path):
        print(f"\n[PKG] ä»®æƒ³ç’°å¢ƒã‚’ç™ºè¦‹: {venv_path}")
        
        # ä»®æƒ³ç’°å¢ƒãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‹ãƒã‚§ãƒƒã‚¯
        if hasattr(sys, 'real_prefix') or (hasattr(sys, 'base_prefix') and sys.base_prefix != sys.prefix):
            print(f"[OK] ä»®æƒ³ç’°å¢ƒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ä¸­")
            return True
        else:
            print(f"[WARN]  ä»®æƒ³ç’°å¢ƒãŒéã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ã™")
            print(f"[HINT] ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ä»®æƒ³ç’°å¢ƒã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆã—ã¦ãã ã•ã„:")
            print(f"source .venv/bin/activate")
            print(f"python3 core/scopusè§£æ.py")
            return False
    else:
        print(f"[PKG] ä»®æƒ³ç’°å¢ƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ - ã‚°ãƒ­ãƒ¼ãƒãƒ«ç’°å¢ƒã§å®Ÿè¡Œ")
        return True

def ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆèµ·å‹•():
    """ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’èµ·å‹•"""
    print(f"\n[START] ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’èµ·å‹•ä¸­...")
    core_script = os.path.join('core', 'scopusè§£æ.py')
    
    if os.path.exists(core_script):
        subprocess.run([sys.executable, core_script])
    else:
        print(f"[NG] ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {core_script}")

def main():
    """ãƒ¡ã‚¤ãƒ³å‡¦ç†"""
    print("[TARGET] Scopusæ–‡çŒ®å¯è¦–åŒ–ã‚·ã‚¹ãƒ†ãƒ  - ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—")
    print("=" * 50)
    
    # Python ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
    if sys.version_info < (3, 7):
        print("[NG] Python 3.7ä»¥ä¸ŠãŒå¿…è¦ã§ã™")
        print(f"ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³: {sys.version}")
        sys.exit(1)
    else:
        print(f"[OK] Python {sys.version_info.major}.{sys.version_info.minor} å¯¾å¿œ")
    
    # ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯ãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    if not ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯ãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«():
        print("\n[NG] ä¾å­˜é–¢ä¿‚ã‚¨ãƒ©ãƒ¼ã«ã‚ˆã‚Šçµ‚äº†ã—ã¾ã™")
        sys.exit(1)
    
    # ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒã‚§ãƒƒã‚¯
    ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒã‚§ãƒƒã‚¯()
    
    # ä»®æƒ³ç’°å¢ƒãƒã‚§ãƒƒã‚¯
    if not ä»®æƒ³ç’°å¢ƒãƒã‚§ãƒƒã‚¯():
        print("\n[NG] ä»®æƒ³ç’°å¢ƒã®å•é¡Œã«ã‚ˆã‚Šçµ‚äº†ã—ã¾ã™")
        sys.exit(1)
    
    # ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—()
    
    # CSVãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
    CSVãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª()
    
    # ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆèµ·å‹•
    ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆèµ·å‹•()

if __name__ == "__main__":
    main()