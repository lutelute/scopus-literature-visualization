#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
setup.py - Scopusæ–‡çŒ®å¯è¦–åŒ–ã‚·ã‚¹ãƒ†ãƒ  è‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
"""

import os
import sys
import subprocess
import importlib.util

def ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç¢ºèª(ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å: str) -> bool:
    """ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯"""
    spec = importlib.util.find_spec(ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å)
    return spec is not None

def å¿…é ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«():
    """å¿…é ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"""
    å¿…é ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ = [
        'pandas',
        'requests', 
        'requests_cache',
        'tqdm'
    ]
    
    ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ = [
        'aiohttp',
        'nltk'
    ]
    
    print("ğŸ” å¿…é ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯ä¸­...")
    ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¿…è¦ = []
    
    for ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ in å¿…é ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸:
        if not ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç¢ºèª(ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸):
            ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¿…è¦.append(ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸)
            print(f"  âŒ {ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸} - æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«")
        else:
            print(f"  âœ… {ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸} - ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿")
    
    if ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¿…è¦:
        print(f"\nğŸ“¦ {len(ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¿…è¦)}å€‹ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™...")
        try:
            subprocess.check_call([
                sys.executable, '-m', 'pip', 'install'
            ] + ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¿…è¦)
            print("âœ… å¿…é ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†")
        except subprocess.CalledProcessError:
            print("âŒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ")
            print("æ‰‹å‹•ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„:")
            print(f"pip install {' '.join(ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¿…è¦)}")
            return False
    else:
        print("âœ… å¿…é ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯å…¨ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã§ã™")
    
    # ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒã‚§ãƒƒã‚¯
    print(f"\nğŸ” ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯ä¸­...")
    æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« = []
    for ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ in ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸:
        if ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç¢ºèª(ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸):
            print(f"  âœ… {ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸} - ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ï¼ˆé«˜é€ŸåŒ–æ©Ÿèƒ½ãŒåˆ©ç”¨å¯èƒ½ï¼‰")
        else:
            print(f"  âš ï¸  {ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸} - æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆæ¨™æº–ç‰ˆã§å‹•ä½œï¼‰")
            æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«.append(ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸)
    
    if æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«:
        print(f"\nğŸ’¡ é«˜é€ŸåŒ–ã®ãŸã‚ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™:")
        print(f"pip install {' '.join(æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«)}")
        print(f"")
        print(f"ğŸ“ æ©Ÿèƒ½èª¬æ˜:")
        print(f"  - aiohttp: DOIè§£æ±ºãŒ8å€é«˜é€ŸåŒ–ï¼ˆä¸¦åˆ—å‡¦ç†ï¼‰")
        print(f"  - nltk: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ†æãŒé«˜ç²¾åº¦åŒ–ï¼ˆå“è©è§£æï¼‰")
    
    return True

def ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ():
    """å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ"""
    å¿…è¦ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª = [
        'JSON_folder',
        'md_folder', 
        'PDF'
    ]
    
    print(f"\nğŸ“ å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆä¸­...")
    for ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª in å¿…è¦ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª:
        if not os.path.exists(ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª):
            os.makedirs(ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª)
            print(f"  ğŸ“ {ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª}/ ã‚’ä½œæˆ")
        else:
            print(f"  âœ… {ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª}/ æ—¢å­˜")

def å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª():
    """å…¥åŠ›CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª"""
    print(f"\nğŸ“„ å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ä¸­...")
    
    # ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
    work_dir = os.getcwd()
    csv_files = [f for f in os.listdir(work_dir) 
                 if f.endswith('.csv') and f != 'scopus_combined.csv']
    
    if csv_files:
        print(f"  âœ… {len(csv_files)}ä»¶ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç™ºè¦‹:")
        for csv_file in csv_files[:3]:  # æœ€åˆã®3ä»¶ã‚’è¡¨ç¤º
            print(f"    - {csv_file}")
        if len(csv_files) > 3:
            print(f"    - ... ä»–{len(csv_files)-3}ä»¶")
        return True
    else:
        print(f"  âŒ CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        print(f"  ğŸ“ ä½¿ç”¨æ–¹æ³•:")
        print(f"    1. ä½œæ¥­ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ")
        print(f"    2. Scopus CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®")
        print(f"    3. git clone ã§ã“ã®ãƒ„ãƒ¼ãƒ«ã‚’ã‚¯ãƒ­ãƒ¼ãƒ³")
        print(f"    4. python3 setup.py ã‚’å®Ÿè¡Œ")
        return False

def å®Ÿè¡Œä¾‹è¡¨ç¤º():
    """å®Ÿè¡Œä¾‹ã‚’è¡¨ç¤º"""
    print(f"\nğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ï¼ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œã—ã¦ãã ã•ã„:")
    print(f"")
    print(f"# æ—¥æœ¬èªç‰ˆï¼ˆæ¨å¥¨ï¼‰")
    print(f"python3 core/scopusè§£æ.py")
    print(f"")
    print(f"# è‹±èªç‰ˆ")
    print(f"python3 main.py")
    print(f"")
    print(f"# PDFå–å¾—")
    print(f"python3 pdf_tools/PDFå–å¾—.py")
    print(f"")
    print(f"# é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç”¨")
    print(f"python3 dev_tools/é€²è¡ŒçŠ¶æ³ç¢ºèª.py")

def main():
    """ãƒ¡ã‚¤ãƒ³å‡¦ç†"""
    print("ğŸ¯ Scopusæ–‡çŒ®å¯è¦–åŒ–ã‚·ã‚¹ãƒ†ãƒ  - è‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—")
    print("=" * 50)
    
    # Python ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
    if sys.version_info < (3, 7):
        print("âŒ Python 3.7ä»¥ä¸ŠãŒå¿…è¦ã§ã™")
        print(f"ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³: {sys.version}")
        sys.exit(1)
    else:
        print(f"âœ… Python {sys.version_info.major}.{sys.version_info.minor} å¯¾å¿œ")
    
    # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    if not å¿…é ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«():
        sys.exit(1)
    
    # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
    ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ()
    
    # å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
    å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª()
    
    # å®Ÿè¡Œä¾‹è¡¨ç¤º
    å®Ÿè¡Œä¾‹è¡¨ç¤º()
    
    print(f"\nğŸ‰ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ï¼")

if __name__ == "__main__":
    main()